"use strict";
var __rest = (this && this.__rest) || function (s, e) {
    var t = {};
    for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p) && e.indexOf(p) < 0)
        t[p] = s[p];
    if (s != null && typeof Object.getOwnPropertySymbols === "function")
        for (var i = 0, p = Object.getOwnPropertySymbols(s); i < p.length; i++) {
            if (e.indexOf(p[i]) < 0 && Object.prototype.propertyIsEnumerable.call(s, p[i]))
                t[p[i]] = s[p[i]];
        }
    return t;
};
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const base_1 = __importDefault(require("./base"));
const request_api_1 = __importDefault(require("../utils/request-api"));
const create_browserstack_status_1 = __importDefault(require("../utils/create-browserstack-status"));
const sharp_1 = __importDefault(require("sharp"));
const TESTS_TIMEOUT = process.env['BROWSERSTACK_TEST_TIMEOUT'] || 1800;
const BROWSERSTACK_API_PATHS = {
    browserList: {
        url: 'https://api.browserstack.com/4/browsers?flat=true',
    },
    newWorker: {
        url: 'https://api.browserstack.com/4/worker',
        method: 'POST',
    },
    getWorkerInfo: id => ({
        url: `https://api.browserstack.com/4/worker/${id}`,
    }),
    deleteWorker: id => ({
        url: `https://api.browserstack.com/4/worker/${id}`,
        method: 'DELETE',
    }),
    screenshot: id => ({
        url: `https://api.browserstack.com/4/worker/${id}/screenshot.png`,
        encoding: null,
    }),
    setStatus: id => ({
        url: `https://api.browserstack.com/automate/sessions/${id}.json`,
        method: 'PUT',
    }),
};
class JSTestingBackend extends base_1.default {
    constructor(...args) {
        super(...args);
        this.workers = {};
    }
    async _requestSessionInfo(id) {
        return await (0, request_api_1.default)(BROWSERSTACK_API_PATHS.getWorkerInfo(this.workers[id].id));
    }
    async _getSessionId(id) {
        var sessionIdMatch = this.workers[id].sessionUrl.match(/[^/]*$/);
        return sessionIdMatch && sessionIdMatch[0];
    }
    async getBrowsersList() {
        var platformsInfo = await (0, request_api_1.default)(BROWSERSTACK_API_PATHS.browserList);
        return platformsInfo.reverse();
    }
    getSessionUrl(id) {
        return this.workers[id] ? this.workers[id].sessionUrl : '';
    }
    async getOSInfo(id) {
        if (this.workers[id])
            return this.workers[id].osInfo;
        return null;
    }
    async openBrowser(id, pageUrl, capabilities) {
        var { local } = capabilities, restCapabilities = __rest(capabilities, ["local"]);
        capabilities = Object.assign({ 'browserstack.local': local, timeout: TESTS_TIMEOUT, url: pageUrl }, restCapabilities);
        this.workers[id] = await (0, request_api_1.default)(BROWSERSTACK_API_PATHS.newWorker, Object.assign({ executeImmediately: true }, capabilities));
        const sessionInfo = await this._requestSessionInfo(id);
        const osInfo = {
            name: sessionInfo['os'] || '',
            version: sessionInfo['os_version'] || ''
        };
        this.workers[id].started = Date.now();
        this.workers[id].sessionUrl = sessionInfo['browser_url'];
        this.workers[id].osInfo = osInfo;
        this.workers[id].sessionId = await this._getSessionId(id);
    }
    async closeBrowser(id) {
        var workerId = this.workers[id].id;
        // Return incase of invalid workerId
        if (!workerId || workerId === '')
            return;
        await (0, request_api_1.default)(BROWSERSTACK_API_PATHS.deleteWorker(workerId));
    }
    async takeScreenshot(id, screenshotPath) {
        var buffer = await (0, request_api_1.default)(BROWSERSTACK_API_PATHS.screenshot(this.workers[id].id));
        var pngBuffer = await (0, sharp_1.default)(buffer).toFormat('png').toBuffer();
        await (0, sharp_1.default)(pngBuffer).toFile(screenshotPath);
    }
    async resizeWindow(id) {
        this.reportWarning(id, 'The window resize functionality is not supported by the Browserstack JS Testing API. Use the Browserstack Automate API.');
    }
    async maximizeWindow(id) {
        this.reportWarning(id, 'The window maximization functionality is not supported by the Browserstack JS Testing API. Use the Browserstack Automate API.');
    }
    async reportJobResult(id, jobResult, jobData, possibleResults) {
        var sessionId = this.workers[id].sessionId;
        var jobStatus = (0, create_browserstack_status_1.default)(jobResult, jobData, possibleResults);
        await (0, request_api_1.default)(BROWSERSTACK_API_PATHS.setStatus(sessionId), { body: jobStatus });
    }
}
exports.default = JSTestingBackend;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoianMtdGVzdGluZy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9iYWNrZW5kcy9qcy10ZXN0aW5nLmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7QUFBQSxrREFBaUM7QUFDakMsdUVBQThDO0FBQzlDLHFHQUEyRTtBQUMzRSxrREFBMEI7QUFHMUIsTUFBTSxhQUFhLEdBQUcsT0FBTyxDQUFDLEdBQUcsQ0FBQywyQkFBMkIsQ0FBQyxJQUFJLElBQUksQ0FBQztBQUV2RSxNQUFNLHNCQUFzQixHQUFHO0lBQzNCLFdBQVcsRUFBRTtRQUNULEdBQUcsRUFBRSxtREFBbUQ7S0FDM0Q7SUFFRCxTQUFTLEVBQUU7UUFDUCxHQUFHLEVBQUssdUNBQXVDO1FBQy9DLE1BQU0sRUFBRSxNQUFNO0tBQ2pCO0lBRUQsYUFBYSxFQUFFLEVBQUUsQ0FBQyxFQUFFLENBQUMsQ0FBQztRQUNsQixHQUFHLEVBQUUseUNBQXlDLEVBQUUsRUFBRTtLQUNyRCxDQUFDO0lBRUYsWUFBWSxFQUFFLEVBQUUsQ0FBQyxFQUFFLENBQUMsQ0FBQztRQUNqQixHQUFHLEVBQUsseUNBQXlDLEVBQUUsRUFBRTtRQUNyRCxNQUFNLEVBQUUsUUFBUTtLQUNuQixDQUFDO0lBRUYsVUFBVSxFQUFFLEVBQUUsQ0FBQyxFQUFFLENBQUMsQ0FBQztRQUNmLEdBQUcsRUFBTyx5Q0FBeUMsRUFBRSxpQkFBaUI7UUFDdEUsUUFBUSxFQUFFLElBQUk7S0FDakIsQ0FBQztJQUVGLFNBQVMsRUFBRSxFQUFFLENBQUMsRUFBRSxDQUFDLENBQUM7UUFDZCxHQUFHLEVBQUssa0RBQWtELEVBQUUsT0FBTztRQUNuRSxNQUFNLEVBQUUsS0FBSztLQUNoQixDQUFDO0NBQ0wsQ0FBQztBQUVGLE1BQXFCLGdCQUFpQixTQUFRLGNBQVc7SUFDckQsWUFBYSxHQUFHLElBQUk7UUFDaEIsS0FBSyxDQUFDLEdBQUcsSUFBSSxDQUFDLENBQUM7UUFFZixJQUFJLENBQUMsT0FB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LENBQUMsQ0FBQztJQUN2RixDQUFDO0NBQ0o7QUFoR0QsbUNBZ0dDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IEJhc2VCYWNrZW5kIGZyb20gJy4vYmFzZSc7XG5pbXBvcnQgcmVxdWVzdEFwaSBmcm9tICcuLi91dGlscy9yZXF1ZXN0LWFwaSc7XG5pbXBvcnQgY3JlYXRlQnJvd3NlcnN0YWNrU3RhdHVzIGZyb20gJy4uL3V0aWxzL2NyZWF0ZS1icm93c2Vyc3RhY2stc3RhdHVzJztcbmltcG9ydCBzaGFycCBmcm9tICdzaGFycCc7XG5cblxuY29uc3QgVEVTVFNfVElNRU9VVCA9IHByb2Nlc3MuZW52WydCUk9XU0VSU1RBQ0tfVEVTVF9USU1FT1VUJ10gfHwgMTgwMDtcblxuY29uc3QgQlJPV1NFUlNUQUNLX0FQSV9QQVRIUyA9IHtcbiAgICBicm93c2VyTGlzdDoge1xuICAgICAgICB1cmw6ICdodHRwczovL2FwaS5icm93c2Vyc3RhY2suY29tLzQvYnJvd3NlcnM/ZmxhdD10cnVlJyxcbiAgICB9LFxuXG4gICAgbmV3V29ya2VyOiB7XG4gICAgICAgIHVybDogICAgJ2h0dHBzOi8vYXBpLmJyb3dzZXJzdGFjay5jb20vNC93b3JrZXInLFxuICAgICAgICBtZXRob2Q6ICdQT1NUJyxcbiAgICB9LFxuXG4gICAgZ2V0V29ya2VySW5mbzogaWQgPT4gKHtcbiAgICAgICAgdXJsOiBgaHR0cHM6Ly9hcGkuYnJvd3NlcnN0YWNrLmNvbS80L3dvcmtlci8ke2lkfWAsXG4gICAgfSksXG5cbiAgICBkZWxldGVXb3JrZXI6IGlkID0+ICh7XG4gICAgICAgIHVybDogICAgYGh0dHBzOi8vYXBpLmJyb3dzZXJzdGFjay5jb20vNC93b3JrZXIvJHtpZH1gLFxuICAgICAgICBtZXRob2Q6ICdERUxFVEUnLFxuICAgIH0pLFxuXG4gICAgc2NyZWVuc2hvdDogaWQgPT4gKHtcbiAgICAgICAgdXJsOiAgICAgIGBodHRwczovL2FwaS5icm93c2Vyc3RhY2suY29tLzQvd29ya2VyLyR7aWR9L3NjcmVlbnNob3QucG5nYCxcbiAgICAgICAgZW5jb2Rpbmc6IG51bGwsXG4gICAgfSksXG5cbiAgICBzZXRTdGF0dXM6IGlkID0+ICh7XG4gICAgICAgIHVybDogICAgYGh0dHBzOi8vYXBpLmJyb3dzZXJzdGFjay5jb20vYXV0b21hdGUvc2Vzc2lvbnMvJHtpZH0uanNvbmAsXG4gICAgICAgIG1ldGhvZDogJ1BVVCcsXG4gICAgfSksXG59O1xuXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBKU1Rlc3RpbmdCYWNrZW5kIGV4dGVuZHMgQmFzZUJhY2tlbmQge1xuICAgIGNvbnN0cnVjdG9yICguLi5hcmdzKSB7XG4gICAgICAgIHN1cGVyKC4uLmFyZ3MpO1xuXG4gICAgICAgIHRoaXMud29ya2VycyA9IHt9O1xuICAgIH1cblxuICAgIGFzeW5jIF9yZXF1ZXN0U2Vzc2lvbkluZm8gKGlkKSB7XG4gICAgICAgIHJldHVybiBhd2FpdCByZXF1ZXN0QXBpKEJST1dTRVJTVEFDS19BUElfUEFUSFMuZ2V0V29ya2VySW5mbyh0aGlzLndvcmtlcnNbaWRdLmlkKSk7XG4gICAgfVxuXG4gICAgYXN5bmMgX2dldFNlc3Npb25JZCAoaWQpIHtcbiAgICAgICAgdmFyIHNlc3Npb25JZE1hdGNoID0gdGhpcy53b3JrZXJzW2lkXS5zZXNzaW9uVXJsLm1hdGNoKC9bXi9dKiQvKTtcblxuICAgICAgICByZXR1cm4gc2Vzc2lvbklkTWF0Y2ggJiYgc2Vzc2lvbklkTWF0Y2hbMF07XG4gICAgfVxuXG4gICAgYXN5bmMgZ2V0QnJvd3NlcnNMaXN0ICgpIHtcbiAgICAgICAgdmFyIHBsYXRmb3Jtc0luZm8gPSBhd2FpdCByZXF1ZXN0QXBpKEJST1dTRVJTVEFDS19BUElfUEFUSFMuYnJvd3Nlckxpc3QpO1xuXG4gICAgICAgIHJldHVybiBwbGF0Zm9ybXNJbmZvLnJldmVyc2UoKTtcbiAgICB9XG5cbiAgICBnZXRTZXNzaW9uVXJsIChpZCkge1xuICAgICAgICByZXR1cm4gdGhpcy53b3JrZXJzW2lkXSA/IHRoaXMud29ya2Vyc1tpZF0uc2Vzc2lvblVybCA6ICcnO1xuICAgIH1cblxuICAgIGFzeW5jIGdldE9TSW5mbyAoaWQpIHtcbiAgICAgICAgaWYgKHRoaXMud29ya2Vyc1tpZF0pXG4gICAgICAgICAgICByZXR1cm4gdGhpcy53b3JrZXJzW2lkXS5vc0luZm87XG5cbiAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgfVxuXG4gICAgYXN5bmMgb3BlbkJyb3dzZXIgKGlkLCBwYWdlVXJsLCBjYXBhYmlsaXRpZXMpIHtcbiAgICAgICAgdmFyIHsgbG9jYWwsIC4uLnJlc3RDYXBhYmlsaXRpZXMgfSA9IGNhcGFiaWxpdGllcztcblxuICAgICAgICBjYXBhYmlsaXRpZXMgPSB7XG4gICAgICAgICAgICAnYnJvd3NlcnN0YWNrLmxvY2FsJzogbG9jYWwsXG5cbiAgICAgICAgICAgIHRpbWVvdXQ6IFRFU1RTX1RJTUVPVVQsXG4gICAgICAgICAgICB1cmw6ICAgICBwYWdlVXJsLFxuXG4gICAgICAgICAgICAuLi5yZXN0Q2FwYWJpbGl0aWVzLFxuICAgICAgICB9O1xuXG4gICAgICAgIHRoaXMud29ya2Vyc1tpZF0gPSBhd2FpdCByZXF1ZXN0QXBpKEJST1dTRVJTVEFDS19BUElfUEFUSFMubmV3V29ya2VyLCB7XG4gICAgICAgICAgICBleGVjdXRlSW1tZWRpYXRlbHk6IHRydWUsXG5cbiAgICAgICAgICAgIC4uLmNhcGFiaWxpdGllcyxcbiAgICAgICAgfSk7XG5cbiAgICAgICAgY29uc3Qgc2Vzc2lvbkluZm8gPSBhd2FpdCB0aGlzLl9yZXF1ZXN0U2Vzc2lvbkluZm8oaWQpO1xuICAgICAgICBjb25zdCBvc0luZm8gICAgICA9IHtcbiAgICAgICAgICAgIG5hbWU6ICAgIHNlc3Npb25JbmZvWydvcyddIHx8ICcnLFxuICAgICAgICAgICAgdmVyc2lvbjogc2Vzc2lvbkluZm9bJ29zX3ZlcnNpb24nXSB8fCAnJ1xuICAgICAgICB9O1xuXG4gICAgICAgIHRoaXMud29ya2Vyc1tpZF0uc3RhcnRlZCAgICA9IERhdGUubm93KCk7XG4gICAgICAgIHRoaXMud29ya2Vyc1tpZF0uc2Vzc2lvblVybCA9IHNlc3Npb25JbmZvWydicm93c2VyX3VybCddO1xuICAgICAgICB0aGlzLndvcmtlcnNbaWRdLm9zSW5mbyAgICAgPSBvc0luZm87XG4gICAgICAgIHRoaXMud29ya2Vyc1tpZF0uc2Vzc2lvbklkICA9IGF3YWl0IHRoaXMuX2dldFNlc3Npb25JZChpZCk7XG4gICAgfVxuXG4gICAgYXN5bmMgY2xvc2VCcm93c2VyIChpZCkge1xuICAgICAgICB2YXIgd29ya2VySWQgPSB0aGlzLndvcmtlcnNbaWRdLmlkO1xuXG4gICAgICAgIC8vIFJldHVybiBpbmNhc2Ugb2YgaW52YWxpZCB3b3JrZXJJZFxuICAgICAgICBpZiAoIXdvcmtlcklkIHx8IHdvcmtlcklkID09PSAnJylcbiAgICAgICAgICAgIHJldHVybjtcblxuICAgICAgICBhd2FpdCByZXF1ZXN0QXBpKEJST1dTRVJTVEFDS19BUElfUEFUSFMuZGVsZXRlV29ya2VyKHdvcmtlcklkKSk7XG5cbiAgICB9XG5cbiAgICBhc3luYyB0YWtlU2NyZWVuc2hvdCAoaWQsIHNjcmVlbnNob3RQYXRoKSB7XG4gICAgICAgIHZhciBidWZmZXIgICAgPSBhd2FpdCByZXF1ZXN0QXBpKEJST1dTRVJTVEFDS19BUElfUEFUSFMuc2NyZWVuc2hvdCh0aGlzLndvcmtlcnNbaWRdLmlkKSk7XG4gICAgICAgIHZhciBwbmdCdWZmZXIgPSBhd2FpdCBzaGFycChidWZmZXIpLnRvRm9ybWF0KCdwbmcnKS50b0J1ZmZlcigpO1xuXG4gICAgICAgIGF3YWl0IHNoYXJwKHBuZ0J1ZmZlcikudG9GaWxlKHNjcmVlbnNob3RQYXRoKTtcbiAgICB9XG5cbiAgICBhc3luYyByZXNpemVXaW5kb3cgKGlkKSB7XG4gICAgICAgIHRoaXMucmVwb3J0V2FybmluZyhpZCwgJ1RoZSB3aW5kb3cgcmVzaXplIGZ1bmN0aW9uYWxpdHkgaXMgbm90IHN1cHBvcnRlZCBieSB0aGUgQnJvd3NlcnN0YWNrIEpTIFRlc3RpbmcgQVBJLiBVc2UgdGhlIEJyb3dzZXJzdGFjayBBdXRvbWF0ZSBBUEkuJyk7XG4gICAgfVxuXG4gICAgYXN5bmMgbWF4aW1pemVXaW5kb3cgKGlkKSB7XG4gICAgICAgIHRoaXMucmVwb3J0V2FybmluZyhpZCwgJ1RoZSB3aW5kb3cgbWF4aW1pemF0aW9uIGZ1bmN0aW9uYWxpdHkgaXMgbm90IHN1cHBvcnRlZCBieSB0aGUgQnJvd3NlcnN0YWNrIEpTIFRlc3RpbmcgQVBJLiBVc2UgdGhlIEJyb3dzZXJzdGFjayBBdXRvbWF0ZSBBUEkuJyk7XG4gICAgfVxuXG4gICAgYXN5bmMgcmVwb3J0Sm9iUmVzdWx0IChpZCwgam9iUmVzdWx0LCBqb2JEYXRhLCBwb3NzaWJsZVJlc3VsdHMpIHtcbiAgICAgICAgdmFyIHNlc3Npb25JZCA9IHRoaXMud29ya2Vyc1tpZF0uc2Vzc2lvbklkO1xuICAgICAgICB2YXIgam9iU3RhdHVzID0gY3JlYXRlQnJvd3NlcnN0YWNrU3RhdHVzKGpvYlJlc3VsdCwgam9iRGF0YSwgcG9zc2libGVSZXN1bHRzKTtcblxuICAgICAgICBhd2FpdCByZXF1ZXN0QXBpKEJST1dTRVJTVEFDS19BUElfUEFUSFMuc2V0U3RhdHVzKHNlc3Npb25JZCksIHsgYm9keTogam9iU3RhdHVzIH0pO1xuICAgIH1cbn1cblxuIl19