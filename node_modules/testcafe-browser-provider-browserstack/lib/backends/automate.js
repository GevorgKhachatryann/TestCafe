"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    var desc = Object.getOwnPropertyDescriptor(m, k);
    if (!desc || ("get" in desc ? !m.__esModule : desc.writable || desc.configurable)) {
      desc = { enumerable: true, get: function() { return m[k]; } };
    }
    Object.defineProperty(o, k2, desc);
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (k !== "default" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);
    __setModuleDefault(result, mod);
    return result;
};
var __rest = (this && this.__rest) || function (s, e) {
    var t = {};
    for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p) && e.indexOf(p) < 0)
        t[p] = s[p];
    if (s != null && typeof Object.getOwnPropertySymbols === "function")
        for (var i = 0, p = Object.getOwnPropertySymbols(s); i < p.length; i++) {
            if (e.indexOf(p[i]) < 0 && Object.prototype.propertyIsEnumerable.call(s, p[i]))
                t[p[i]] = s[p[i]];
        }
    return t;
};
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const util_1 = require("util");
const base_1 = __importDefault(require("./base"));
const request_api_1 = __importDefault(require("../utils/request-api"));
const create_browserstack_status_1 = __importDefault(require("../utils/create-browserstack-status"));
const get_api_polling_interval_1 = __importDefault(require("../utils/get-api-polling-interval"));
const ERROR_MESSAGES = __importStar(require("../templates/error-messages"));
const sharp_1 = __importDefault(require("sharp"));
const API_POLLING_INTERVAL = (0, get_api_polling_interval_1.default)();
const BROWSERSTACK_API_PATHS = {
    browserList: {
        url: 'https://api.browserstack.com/automate/browsers.json'
    },
    newSession: {
        url: 'https://hub-cloud.browserstack.com/wd/hub/session',
        method: 'POST'
    },
    openUrl: id => ({
        url: `https://hub-cloud.browserstack.com/wd/hub/session/${id}/url`,
        method: 'POST'
    }),
    getWindowSize: id => ({
        url: `https://hub-cloud.browserstack.com/wd/hub/session/${id}/window/current/size`
    }),
    setWindowSize: id => ({
        url: `https://hub-cloud.browserstack.com/wd/hub/session/${id}/window/current/size`,
        method: 'POST'
    }),
    maximizeWindow: id => ({
        url: `https://hub-cloud.browserstack.com/wd/hub/session/${id}/window/current/maximize`,
        method: 'POST'
    }),
    getUrl: id => ({
        url: `https://hub-cloud.browserstack.com/wd/hub/session/${id}/url`
    }),
    deleteSession: id => ({
        url: `https://hub-cloud.browserstack.com/wd/hub/session/${id}`,
        method: 'DELETE'
    }),
    screenshot: id => ({
        url: `https://hub-cloud.browserstack.com/wd/hub/session/${id}/screenshot`
    }),
    getStatus: id => ({
        url: `https://api.browserstack.com/automate/sessions/${id}.json`
    }),
    setStatus: id => ({
        url: `https://api.browserstack.com/automate/sessions/${id}.json`,
        method: 'PUT'
    })
};
function requestApi(path, params) {
    return (0, request_api_1.default)(path, params)
        .then(response => {
        if (response.status) {
            throw new Error(ERROR_MESSAGES.REMOTE_API_REQUEST_FAILED({
                status: response.status,
                apiResponse: response.value && response.value.message || (0, util_1.inspect)(response)
            }));
        }
        return response;
    });
}
function getCorrectedSize(currentClientAreaSize, currentWindowSize, requestedSize) {
    var horizontalChrome = currentWindowSize.width - currentClientAreaSize.width;
    var verticalChrome = currentWindowSize.height - currentClientAreaSize.height;
    return {
        width: requestedSize.width + horizontalChrome,
        height: requestedSize.height + verticalChrome
    };
}
class AutomateBackend extends base_1.default {
    constructor(...args) {
        super(...args);
        this.sessions = {};
    }
    static _ensureSessionId(sessionInfo) {
        const sessionData = sessionInfo.value || {};
        const sessionCapabilities = sessionData.capabilities || {};
        sessionInfo.sessionId = sessionInfo.sessionId ||
            sessionData.sessionId ||
            sessionData['webdriver.remote.sessionid'] ||
            sessionCapabilities['webdriver.remote.sessionid'];
        if (!sessionInfo.sessionId) {
            throw new Error(ERROR_MESSAGES.SESSION_ID_NOT_FOUND({
                sessionInfoDump: (0, util_1.inspect)(sessionInfo)
            }));
        }
    }
    async _requestSessionInfo(id) {
        var sessionInfo = await (0, request_api_1.default)(BROWSERSTACK_API_PATHS.getStatus(this.sessions[id].sessionId));
        return sessionInfo['automation_session'];
    }
    async _requestCurrentWindowSize(id) {
        var currentWindowSizeData = await requestApi(BROWSERSTACK_API_PATHS.getWindowSize(this.sessions[id].sessionId));
        return {
            width: currentWindowSizeData.value.width,
            height: currentWindowSizeData.value.height
        };
    }
    async getBrowsersList() {
        var platformsInfo = await (0, request_api_1.default)(BROWSERSTACK_API_PATHS.browserList);
        return platformsInfo.reverse();
    }
    getSessionUrl(id) {
        return this.sessions[id] ? this.sessions[id].sessionUrl : '';
    }
    async getOSInfo(id) {
        if (this.sessions[id])
            return this.sessions[id].osInfo;
        return null;
    }
    async openBrowser(id, pageUrl, capabilities) {
        var { localIdentifier, local } = capabilities, restCapabilities = __rest(capabilities, ["localIdentifier", "local"]);
        capabilities = Object.assign({ 'browserstack.localIdentifier': localIdentifier, 'browserstack.local': local }, restCapabilities);
        this.sessions[id] = await requestApi(BROWSERSTACK_API_PATHS.newSession, {
            body: { desiredCapabilities: capabilities },
            executeImmediately: true
        });
        AutomateBackend._ensureSessionId(this.sessions[id]);
        const sessionInfo = await this._requestSessionInfo(id);
        const osInfo = {
            name: sessionInfo['os'] || '',
            version: sessionInfo['os_version'] || ''
        };
        this.sessions[id].sessionUrl = sessionInfo['browser_url'];
        this.sessions[id].osInfo = osInfo;
        var sessionId = this.sessions[id].sessionId;
        this.sessions[id].interval = setInterval(() => requestApi(BROWSERSTACK_API_PATHS.getUrl(sessionId), { executeImmediately: true }), API_POLLING_INTERVAL);
        await requestApi(BROWSERSTACK_API_PATHS.openUrl(sessionId), { body: { url: pageUrl } });
    }
    async closeBrowser(id) {
        const session = this.sessions[id];
        if (!session)
            return;
        clearInterval(session.interval);
        delete this.sessions[id];
        // Delete session whose sessionId is created
        if (session.sessionId && session.sessionId !== '')
            await requestApi(BROWSERSTACK_API_PATHS.deleteSession(session.sessionId));
    }
    async takeScreenshot(id, screenshotPath) {
        var base64Data = await requestApi(BROWSERSTACK_API_PATHS.screenshot(this.sessions[id].sessionId));
        var buffer = Buffer.from(base64Data.value, 'base64');
        await (0, sharp_1.default)(buffer).toFile(screenshotPath);
    }
    async resizeWindow(id, width, height, currentWidth, currentHeight) {
        var sessionId = this.sessions[id].sessionId;
        var currentWindowSize = await this._requestCurrentWindowSize(id);
        var currentClientAreaSize = { width: currentWidth, height: currentHeight };
        var requestedSize = { width, height };
        var correctedSize = getCorrectedSize(currentClientAreaSize, currentWindowSize, requestedSize);
        await requestApi(BROWSERSTACK_API_PATHS.setWindowSize(sessionId), { body: correctedSize });
    }
    async maximizeWindow(id) {
        await requestApi(BROWSERSTACK_API_PATHS.maximizeWindow(this.sessions[id].sessionId));
    }
    async reportJobResult(id, jobResult, jobData, possibleResults) {
        var sessionId = this.sessions[id].sessionId;
        var jobStatus = (0, create_browserstack_status_1.default)(jobResult, jobData, possibleResults);
        await (0, request_api_1.default)(BROWSERSTACK_API_PATHS.setStatus(sessionId), { body: jobStatus });
    }
}
exports.default = AutomateBackend;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXV0b21hdGUuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvYmFja2VuZHMvYXV0b21hdGUuanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBQUEsK0JBQStCO0FBQy9CLGtEQUFpQztBQUNqQyx1RUFBa0Q7QUFDbEQscUdBQTJFO0FBQzNFLGlHQUFzRTtBQUN0RSw0RUFBOEQ7QUFDOUQsa0RBQTBCO0FBRTFCLE1BQU0sb0JBQW9CLEdBQUcsSUFBQSxrQ0FBcUIsR0FBRSxDQUFDO0FBRXJELE1BQU0sc0JBQXNCLEdBQUc7SUFDM0IsV0FBVyxFQUFFO1FBQ1QsR0FBRyxFQUFFLHFEQUFxRDtLQUM3RDtJQUVELFVBQVUsRUFBRTtRQUNSLEdBQUcsRUFBSyxtREFBbUQ7UUFDM0QsTUFBTSxFQUFFLE1BQU07S0FDakI7SUFFRCxPQUFPLEVBQUUsRUFBRSxDQUFDLEVBQUUsQ0FBQyxDQUFDO1FBQ1osR0FBRyxFQUFLLHFEQUFxRCxFQUFFLE1BQU07UUFDckUsTUFBTSxFQUFFLE1BQU07S0FDakIsQ0FBQztJQUVGLGFBQWEsRUFBRSxFQUFFLENBQUMsRUFBRSxDQUFDLENBQUM7UUFDbEIsR0FBRyxFQUFFLHFEQUFxRCxFQUFFLHNCQUFzQjtLQUNyRixDQUFDO0lBRUYsYUFBYSxFQUFFLEVBQUUsQ0FBQyxFQUFFLENBQUMsQ0FBQztRQUNsQixHQUFHLEVBQUsscURBQXFELEVBQUUsc0JBQXNCO1FBQ3JGLE1BQU0sRUFBRSxNQUFNO0tBQ2pCLENBQUM7SUFFRixjQUFjLEVBQUUsRUFBRSxDQUFDLEVBQUUsQ0FBQyxDQUFDO1FBQ25CLEdBQUcsRUFBSyxxREFBcUQsRUFBRSwwQkFBMEI7UUFDekYsTUFBTSxFQUFFLE1BQU07S0FDakIsQ0FBQztJQUVGLE1BQU0sRUFBRSxFQUFFLENBQUMsRUFBRSxDQUFDLENBQUM7UUFDWCxHQUFHLEVBQUUscURBQXFELEVBQUUsTUFBTTtL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QU8sTUFBTSxJQUFJLENBQUMseUJBQXlCLENBQUMsRUFBRSxDQUFDLENBQUM7UUFDckUsSUFBSSxxQkFBcUIsR0FBRyxFQUFFLEtBQUssRUFBRSxZQUFZLEVBQUUsTUFBTSxFQUFFLGFBQWEsRUFBRSxDQUFDO1FBQzNFLElBQUksYUFBYSxHQUFXLEVBQUUsS0FBSyxFQUFFLE1BQU0sRUFBRSxDQUFDO1FBQzlDLElBQUksYUFBYSxHQUFXLGdCQUFnQixDQUFDLHFCQUFxQixFQUFFLGlCQUFpQixFQUFFLGFBQWEsQ0FBQyxDQUFDO1FBRXRHLE1BQU0sVUFBVSxDQUFDLHNCQUFzQixDQUFDLGFBQWEsQ0FBQyxTQUFTLENBQUMsRUFBRSxFQUFFLElBQUksRUFBRSxhQUFhLEVBQUUsQ0FBQyxDQUFDO0lBQy9GLENBQUM7SUFFRCxLQUFLLENBQUMsY0FBYyxDQUFFLEVBQUU7UUFDcEIsTUFBTSxVQUFVLENBQUMsc0JBQXNCLENBQUMsY0FBYyxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsRUFBRSxDQUFDLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQztJQUN6RixDQUFDO0lBRUQsS0FBSyxDQUFDLGVBQWUsQ0FBRSxFQUFFLEVBQUUsU0FBUyxFQUFFLE9BQU8sRUFBRSxlQUFlO1FBQzFELElBQUksU0FBUyxHQUFHLElBQUksQ0FBQyxRQUFRLENBQUMsRUFBRSxDQUFDLENBQUMsU0FBUyxDQUFDO1FBQzVDLElBQUksU0FBUyxHQUFHLElBQUEsb0NBQXdCLEVBQUMsU0FBUyxFQUFFLE9BQU8sRUFBRSxlQUFlLENBQUMsQ0FBQztRQUU5RSxNQUFNLElBQUEscUJBQWMsRUFBQyxzQkFBc0IsQ0FBQyxTQUFTLENBQUMsU0FBUyxDQUFDLEVBQUUsRUFBRSxJQUFJLEVBQUUsU0FBUyxFQUFFLENBQUMsQ0FBQztJQUMzRixDQUFDO0NBQ0o7QUFsSUQsa0NBa0lDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgaW5zcGVjdCB9IGZyb20gJ3V0aWwnO1xuaW1wb3J0IEJhc2VCYWNrZW5kIGZyb20gJy4vYmFzZSc7XG5pbXBvcnQgcmVxdWVzdEFwaUJhc2UgZnJvbSAnLi4vdXRpbHMvcmVxdWVzdC1hcGknO1xuaW1wb3J0IGNyZWF0ZUJyb3dzZXJzdGFja1N0YXR1cyBmcm9tICcuLi91dGlscy9jcmVhdGUtYnJvd3NlcnN0YWNrLXN0YXR1cyc7XG5pbXBvcnQgZ2V0QVBJUG9sbGluZ0ludGVydmFsIGZyb20gJy4uL3V0aWxzL2dldC1hcGktcG9sbGluZy1pbnRlcnZhbCc7XG5pbXBvcnQgKiBhcyBFUlJPUl9NRVNTQUdFUyBmcm9tICcuLi90ZW1wbGF0ZXMvZXJyb3ItbWVzc2FnZXMnO1xuaW1wb3J0IHNoYXJwIGZyb20gJ3NoYXJwJztcblxuY29uc3QgQVBJX1BPTExJTkdfSU5URVJWQUwgPSBnZXRBUElQb2xsaW5nSW50ZXJ2YWwoKTtcblxuY29uc3QgQlJPV1NFUlNUQUNLX0FQSV9QQVRIUyA9IHtcbiAgICBicm93c2VyTGlzdDoge1xuICAgICAgICB1cmw6ICdodHRwczovL2FwaS5icm93c2Vyc3RhY2suY29tL2F1dG9tYXRlL2Jyb3dzZXJzLmpzb24nXG4gICAgfSxcblxuICAgIG5ld1Nlc3Npb246IHtcbiAgICAgICAgdXJsOiAgICAnaHR0cHM6Ly9odWItY2xvdWQuYnJvd3NlcnN0YWNrLmNvbS93ZC9odWIvc2Vzc2lvbicsXG4gICAgICAgIG1ldGhvZDogJ1BPU1QnXG4gICAgfSxcblxuICAgIG9wZW5Vcmw6IGlkID0+ICh7XG4gICAgICAgIHVybDogICAgYGh0dHBzOi8vaHViLWNsb3VkLmJyb3dzZXJzdGFjay5jb20vd2QvaHViL3Nlc3Npb24vJHtpZH0vdXJsYCxcbiAgICAgICAgbWV0aG9kOiAnUE9TVCdcbiAgICB9KSxcblxuICAgIGdldFdpbmRvd1NpemU6IGlkID0+ICh7XG4gICAgICAgIHVybDogYGh0dHBzOi8vaHViLWNsb3VkLmJyb3dzZXJzdGFjay5jb20vd2QvaHViL3Nlc3Npb24vJHtpZH0vd2luZG93L2N1cnJlbnQvc2l6ZWBcbiAgICB9KSxcblxuICAgIHNldFdpbmRvd1NpemU6IGlkID0+ICh7XG4gICAgICAgIHVybDogICAgYGh0dHBzOi8vaHViLWNsb3VkLmJyb3dzZXJzdGFjay5jb20vd2QvaHViL3Nlc3Npb24vJHtpZH0vd2luZG93L2N1cnJlbnQvc2l6ZWAsXG4gICAgICAgIG1ldGhvZDogJ1BPU1QnXG4gICAgfSksXG5cbiAgICBtYXhpbWl6ZVdpbmRvdzogaWQgPT4gKHtcbiAgICAgICAgdXJsOiAgICBgaHR0cHM6Ly9odWItY2xvdWQuYnJvd3NlcnN0YWNrLmNvbS93ZC9odWIvc2Vzc2lvbi8ke2lkfS93aW5kb3cvY3VycmVudC9tYXhpbWl6ZWAsXG4gICAgICAgIG1ldGhvZDogJ1BPU1QnXG4gICAgfSksXG5cbiAgICBnZXRVcmw6IGlkID0+ICh7XG4gICAgICAgIHVybDogYGh0dHBzOi8vaHViLWNsb3VkLmJyb3dzZXJzdGFjay5jb20vd2QvaHViL3Nlc3Npb24vJHtpZH0vdXJsYFxuICAgIH0pLFxuXG4gICAgZGVsZXRlU2Vzc2lvbjogaWQgPT4gKHtcbiAgICAgICAgdXJsOiAgICBgaHR0cHM6Ly9odWItY2xvdWQuYnJvd3NlcnN0YWNrLmNvbS93ZC9odWIvc2Vzc2lvbi8ke2lkfWAsXG4gICAgICAgIG1ldGhvZDogJ0RFTEVURSdcbiAgICB9KSxcblxuICAgIHNjcmVlbnNob3Q6IGlkID0+ICh7XG4gICAgICAgIHVybDogYGh0dHBzOi8vaHViLWNsb3VkLmJyb3dzZXJzdGFjay5jb20vd2QvaHViL3Nlc3Npb24vJHtpZH0vc2NyZWVuc2hvdGBcbiAgICB9KSxcblxuICAgIGdldFN0YXR1czogaWQgPT4gKHtcbiAgICAgICAgdXJsOiBgaHR0cHM6Ly9hcGkuYnJvd3NlcnN0YWNrLmNvbS9hdXRvbWF0ZS9zZXNzaW9ucy8ke2lkfS5qc29uYFxuICAgIH0pLFxuXG4gICAgc2V0U3RhdHVzOiBpZCA9PiAoe1xuICAgICAgICB1cmw6ICAgIGBodHRwczovL2FwaS5icm93c2Vyc3RhY2suY29tL2F1dG9tYXRlL3Nlc3Npb25zLyR7aWR9Lmpzb25gLFxuICAgICAgICBtZXRob2Q6ICdQVVQnXG4gICAgfSlcbn07XG5cblxuZnVuY3Rpb24gcmVxdWVzdEFwaSAocGF0aCwgcGFyYW1zKSB7XG4gICAgcmV0dXJuIHJlcXVlc3RBcGlCYXNlKHBhdGgsIHBhcmFtcylcbiAgICAgICAgLnRoZW4ocmVzcG9uc2UgPT4ge1xuICAgICAgICAgICAgaWYgKHJlc3BvbnNlLnN0YXR1cykge1xuICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihFUlJPUl9NRVNTQUdFUy5SRU1PVEVfQVBJX1JFUVVFU1RfRkFJTEVEKHtcbiAgICAgICAgICAgICAgICAgICAgc3RhdHVzOiAgICAgIHJlc3BvbnNlLnN0YXR1cyxcbiAgICAgICAgICAgICAgICAgICAgYXBpUmVzcG9uc2U6IHJlc3BvbnNlLnZhbHVlICYmIHJlc3BvbnNlLnZhbHVlLm1lc3NhZ2UgfHwgaW5zcGVjdChyZXNwb25zZSlcbiAgICAgICAgICAgICAgICB9KSk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHJldHVybiByZXNwb25zZTtcbiAgICAgICAgfSk7XG59XG5cbmZ1bmN0aW9uIGdldENvcnJlY3RlZFNpemUgKGN1cnJlbnRDbGllbnRBcmVhU2l6ZSwgY3VycmVudFdpbmRvd1NpemUsIHJlcXVlc3RlZFNpemUpIHtcbiAgICB2YXIgaG9yaXpvbnRhbENocm9tZSA9IGN1cnJlbnRXaW5kb3dTaXplLndpZHRoIC0gY3VycmVudENsaWVudEFyZWFTaXplLndpZHRoO1xuICAgIHZhciB2ZXJ0aWNhbENocm9tZSAgID0gY3VycmVudFdpbmRvd1NpemUuaGVpZ2h0IC0gY3VycmVudENsaWVudEFyZWFTaXplLmhlaWdodDtcblxuICAgIHJldHVybiB7XG4gICAgICAgIHdpZHRoOiAgcmVxdWVzdGVkU2l6ZS53aWR0aCArIGhvcml6b250YWxDaHJvbWUsXG4gICAgICAgIGhlaWdodDogcmVxdWVzdGVkU2l6ZS5oZWlnaHQgKyB2ZXJ0aWNhbENocm9tZVxuICAgIH07XG59XG5cbmV4cG9ydCBkZWZhdWx0IGNsYXNzIEF1dG9tYXRlQmFja2VuZCBleHRlbmRzIEJhc2VCYWNrZW5kIHtcbiAgICBjb25zdHJ1Y3RvciAoLi4uYXJncykge1xuICAgICAgICBzdXBlciguLi5hcmdzKTtcblxuICAgICAgICB0aGlzLnNlc3Npb25zID0ge307XG4gICAgfVxuXG4gICAgc3RhdGljIF9lbnN1cmVTZXNzaW9uSWQgKHNlc3Npb25JbmZvKSB7XG4gICAgICAgIGNvbnN0IHNlc3Npb25EYXRhICAgICAgICAgPSBzZXNzaW9uSW5mby52YWx1ZSB8fCB7fTtcbiAgICAgICAgY29uc3Qgc2Vzc2lvbkNhcGFiaWxpdGllcyA9IHNlc3Npb25EYXRhLmNhcGFiaWxpdGllcyB8fCB7fTtcblxuICAgICAgICBzZXNzaW9uSW5mby5zZXNzaW9uSWQgPSBzZXNzaW9uSW5mby5zZXNzaW9uSWQgfHxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2Vzc2lvbkRhdGEuc2Vzc2lvbklkIHx8XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlc3Npb25EYXRhWyd3ZWJkcml2ZXIucmVtb3RlLnNlc3Npb25pZCddIHx8XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlc3Npb25DYXBhYmlsaXRpZXNbJ3dlYmRyaXZlci5yZW1vdGUuc2Vzc2lvbmlkJ107XG5cbiAgICAgICAgaWYgKCFzZXNzaW9uSW5mby5zZXNzaW9uSWQpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihFUlJPUl9NRVNTQUdFUy5TRVNTSU9OX0lEX05PVF9GT1VORCh7XG4gICAgICAgICAgICAgICAgc2Vzc2lvbkluZm9EdW1wOiBpbnNwZWN0KHNlc3Npb25JbmZvKVxuICAgICAgICAgICAgfSkpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgYXN5bmMgX3JlcXVlc3RTZXNzaW9uSW5mbyAoaWQpIHtcbiAgICAgICAgdmFyIHNlc3Npb25JbmZvID0gYXdhaXQgcmVxdWVzdEFwaUJhc2UoQlJPV1NFUlNUQUNLX0FQSV9QQVRIUy5nZXRTdGF0dXModGhpcy5zZXNzaW9uc1tpZF0uc2Vzc2lvbklkKSk7XG5cbiAgICAgICAgcmV0dXJuIHNlc3Npb25JbmZvWydhdXRvbWF0aW9uX3Nlc3Npb24nXTtcbiAgICB9XG5cbiAgICBhc3luYyBfcmVxdWVzdEN1cnJlbnRXaW5kb3dTaXplIChpZCkge1xuICAgICAgICB2YXIgY3VycmVudFdpbmRvd1NpemVEYXRhID0gYXdhaXQgcmVxdWVzdEFwaShCUk9XU0VSU1RBQ0tfQVBJX1BBVEhTLmdldFdpbmRvd1NpemUodGhpcy5zZXNzaW9uc1tpZF0uc2Vzc2lvbklkKSk7XG5cbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgIHdpZHRoOiAgY3VycmVudFdpbmRvd1NpemVEYXRhLnZhbHVlLndpZHRoLFxuICAgICAgICAgICAgaGVpZ2h0OiBjdXJyZW50V2luZG93U2l6ZURhdGEudmFsdWUuaGVpZ2h0XG4gICAgICAgIH07XG4gICAgfVxuXG4gICAgYXN5bmMgZ2V0QnJvd3NlcnNMaXN0ICgpIHtcbiAgICAgICAgdmFyIHBsYXRmb3Jtc0luZm8gPSBhd2FpdCByZXF1ZXN0QXBpQmFzZShCUk9XU0VSU1RBQ0tfQVBJX1BBVEhTLmJyb3dzZXJMaXN0KTtcblxuICAgICAgICByZXR1cm4gcGxhdGZvcm1zSW5mby5yZXZlcnNlKCk7XG4gICAgfVxuXG4gICAgZ2V0U2Vzc2lvblVybCAoaWQpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuc2Vzc2lvbnNbaWRdID8gdGhpcy5zZXNzaW9uc1tpZF0uc2Vzc2lvblVybCA6ICcnO1xuICAgIH1cblxuICAgIGFzeW5jIGdldE9TSW5mbyAoaWQpIHtcbiAgICAgICAgaWYgKHRoaXMuc2Vzc2lvbnNbaWRdKVxuICAgICAgICAgICAgcmV0dXJuIHRoaXMuc2Vzc2lvbnNbaWRdLm9zSW5mbztcblxuICAgICAgICByZXR1cm4gbnVsbDtcbiAgICB9XG5cbiAgICBhc3luYyBvcGVuQnJvd3NlciAoaWQsIHBhZ2VVcmwsIGNhcGFiaWxpdGllcykge1xuICAgICAgICB2YXIgeyBsb2NhbElkZW50aWZpZXIsIGxvY2FsLCAuLi5yZXN0Q2FwYWJpbGl0aWVzIH0gPSBjYXBhYmlsaXRpZXM7XG5cbiAgICAgICAgY2FwYWJpbGl0aWVzID0ge1xuICAgICAgICAgICAgJ2Jyb3dzZXJzdGFjay5sb2NhbElkZW50aWZpZXInOiBsb2NhbElkZW50aWZpZXIsXG4gICAgICAgICAgICAnYnJvd3NlcnN0YWNrLmxvY2FsJzogICAgICAgICAgIGxvY2FsLFxuICAgICAgICAgICAgLi4ucmVzdENhcGFiaWxpdGllc1xuICAgICAgICB9O1xuXG4gICAgICAgIHRoaXMuc2Vzc2lvbnNbaWRdID0gYXdhaXQgcmVxdWVzdEFwaShCUk9XU0VSU1RBQ0tfQVBJX1BBVEhTLm5ld1Nlc3Npb24sIHtcbiAgICAgICAgICAgIGJvZHk6IHsgZGVzaXJlZENhcGFiaWxpdGllczogY2FwYWJpbGl0aWVzIH0sXG5cbiAgICAgICAgICAgIGV4ZWN1dGVJbW1lZGlhdGVseTogdHJ1ZVxuICAgICAgICB9KTtcblxuICAgICAgICBBdXRvbWF0ZUJhY2tlbmQuX2Vuc3VyZVNlc3Npb25JZCh0aGlzLnNlc3Npb25zW2lkXSk7XG5cbiAgICAgICAgY29uc3Qgc2Vzc2lvbkluZm8gPSBhd2FpdCB0aGlzLl9yZXF1ZXN0U2Vzc2lvbkluZm8oaWQpO1xuICAgICAgICBjb25zdCBvc0luZm8gICAgICA9IHtcbiAgICAgICAgICAgIG5hbWU6ICAgIHNlc3Npb25JbmZvWydvcyddIHx8ICcnLFxuICAgICAgICAgICAgdmVyc2lvbjogc2Vzc2lvbkluZm9bJ29zX3ZlcnNpb24nXSB8fCAnJ1xuICAgICAgICB9O1xuXG4gICAgICAgIHRoaXMuc2Vzc2lvbnNbaWRdLnNlc3Npb25VcmwgPSBzZXNzaW9uSW5mb1snYnJvd3Nlcl91cmwnXTtcbiAgICAgICAgdGhpcy5zZXNzaW9uc1tpZF0ub3NJbmZvICAgICA9IG9zSW5mbztcblxuICAgICAgICB2YXIgc2Vzc2lvbklkID0gdGhpcy5zZXNzaW9uc1tpZF0uc2Vzc2lvbklkO1xuXG4gICAgICAgIHRoaXMuc2Vzc2lvbnNbaWRdLmludGVydmFsID0gc2V0SW50ZXJ2YWwoKCkgPT4gcmVxdWVzdEFwaShCUk9XU0VSU1RBQ0tfQVBJX1BBVEhTLmdldFVybChzZXNzaW9uSWQpLCB7IGV4ZWN1dGVJbW1lZGlhdGVseTogdHJ1ZSB9KSwgQVBJX1BPTExJTkdfSU5URVJWQUwpO1xuXG4gICAgICAgIGF3YWl0IHJlcXVlc3RBcGkoQlJPV1NFUlNUQUNLX0FQSV9QQVRIUy5vcGVuVXJsKHNlc3Npb25JZCksIHsgYm9keTogeyB1cmw6IHBhZ2VVcmwgfSB9KTtcbiAgICB9XG5cbiAgICBhc3luYyBjbG9zZUJyb3dzZXIgKGlkKSB7XG4gICAgICAgIGNvbnN0IHNlc3Npb24gPSB0aGlzLnNlc3Npb25zW2lkXTtcblxuICAgICAgICBpZiAoIXNlc3Npb24pXG4gICAgICAgICAgICByZXR1cm47XG5cbiAgICAgICAgY2xlYXJJbnRlcnZhbChzZXNzaW9uLmludGVydmFsKTtcblxuICAgICAgICBkZWxldGUgdGhpcy5zZXNzaW9uc1tpZF07XG5cbiAgICAgICAgLy8gRGVsZXRlIHNlc3Npb24gd2hvc2Ugc2Vzc2lvbklkIGlzIGNyZWF0ZWRcbiAgICAgICAgaWYgKHNlc3Npb24uc2Vzc2lvbklkICYmIHNlc3Npb24uc2Vzc2lvbklkICE9PSAnJylcbiAgICAgICAgICAgIGF3YWl0IHJlcXVlc3RBcGkoQlJPV1NFUlNUQUNLX0FQSV9QQVRIUy5kZWxldGVTZXNzaW9uKHNlc3Npb24uc2Vzc2lvbklkKSk7XG4gICAgfVxuXG4gICAgYXN5bmMgdGFrZVNjcmVlbnNob3QgKGlkLCBzY3JlZW5zaG90UGF0aCkge1xuICAgICAgICB2YXIgYmFzZTY0RGF0YSAgPSBhd2FpdCByZXF1ZXN0QXBpKEJST1dTRVJTVEFDS19BUElfUEFUSFMuc2NyZWVuc2hvdCh0aGlzLnNlc3Npb25zW2lkXS5zZXNzaW9uSWQpKTtcbiAgICAgICAgdmFyIGJ1ZmZlciAgICAgID0gQnVmZmVyLmZyb20oYmFzZTY0RGF0YS52YWx1ZSwgJ2Jhc2U2NCcpO1xuICAgICAgICBcbiAgICAgICAgYXdhaXQgc2hhcnAoYnVmZmVyKS50b0ZpbGUoc2NyZWVuc2hvdFBhdGgpO1xuICAgIH1cblxuICAgIGFzeW5jIHJlc2l6ZVdpbmRvdyAoaWQsIHdpZHRoLCBoZWlnaHQsIGN1cnJlbnRXaWR0aCwgY3VycmVudEhlaWdodCkge1xuICAgICAgICB2YXIgc2Vzc2lvbklkICAgICAgICAgICAgID0gdGhpcy5zZXNzaW9uc1tpZF0uc2Vzc2lvbklkO1xuICAgICAgICB2YXIgY3VycmVudFdpbmRvd1NpemUgICAgID0gYXdhaXQgdGhpcy5fcmVxdWVzdEN1cnJlbnRXaW5kb3dTaXplKGlkKTtcbiAgICAgICAgdmFyIGN1cnJlbnRDbGllbnRBcmVhU2l6ZSA9IHsgd2lkdGg6IGN1cnJlbnRXaWR0aCwgaGVpZ2h0OiBjdXJyZW50SGVpZ2h0IH07XG4gICAgICAgIHZhciByZXF1ZXN0ZWRTaXplICAgICAgICAgPSB7IHdpZHRoLCBoZWlnaHQgfTtcbiAgICAgICAgdmFyIGNvcnJlY3RlZFNpemUgICAgICAgICA9IGdldENvcnJlY3RlZFNpemUoY3VycmVudENsaWVudEFyZWFTaXplLCBjdXJyZW50V2luZG93U2l6ZSwgcmVxdWVzdGVkU2l6ZSk7XG5cbiAgICAgICAgYXdhaXQgcmVxdWVzdEFwaShCUk9XU0VSU1RBQ0tfQVBJX1BBVEhTLnNldFdpbmRvd1NpemUoc2Vzc2lvbklkKSwgeyBib2R5OiBjb3JyZWN0ZWRTaXplIH0pO1xuICAgIH1cblxuICAgIGFzeW5jIG1heGltaXplV2luZG93IChpZCkge1xuICAgICAgICBhd2FpdCByZXF1ZXN0QXBpKEJST1dTRVJTVEFDS19BUElfUEFUSFMubWF4aW1pemVXaW5kb3codGhpcy5zZXNzaW9uc1tpZF0uc2Vzc2lvbklkKSk7XG4gICAgfVxuXG4gICAgYXN5bmMgcmVwb3J0Sm9iUmVzdWx0IChpZCwgam9iUmVzdWx0LCBqb2JEYXRhLCBwb3NzaWJsZVJlc3VsdHMpIHtcbiAgICAgICAgdmFyIHNlc3Npb25JZCA9IHRoaXMuc2Vzc2lvbnNbaWRdLnNlc3Npb25JZDtcbiAgICAgICAgdmFyIGpvYlN0YXR1cyA9IGNyZWF0ZUJyb3dzZXJzdGFja1N0YXR1cyhqb2JSZXN1bHQsIGpvYkRhdGEsIHBvc3NpYmxlUmVzdWx0cyk7XG5cbiAgICAgICAgYXdhaXQgcmVxdWVzdEFwaUJhc2UoQlJPV1NFUlNUQUNLX0FQSV9QQVRIUy5zZXRTdGF0dXMoc2Vzc2lvbklkKSwgeyBib2R5OiBqb2JTdGF0dXMgfSk7XG4gICAgfVxufVxuIl19